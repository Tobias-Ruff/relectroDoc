# SpikeTrain
This chapter documents the use of the SpikeTrain class. 
SpikeTrain object represents the spike trains of a group of neurons recorded in the same recording session. 
The spike trains are usually loaded from files containing the spike times in sample values, the id of the cell firing and the sampling rate. 
You have to call the function `loadSpikeTrain()` to read the data from the files. 
The 3 files from which the data are loaded have the extension `res`, `clu` and `sampling_rate_dat`. 

Note that you can also set the data manually with `setSpikeTrain()`. This feature is usefull if you want to work with simulated spike trains. 

Once a SpikeTrain object is set, you can use different functions to do analysis on the spike trains. For example you can calculate spike-train autocorrelations using the function `spikeTimeAutocorrelation()`. You can also calculate the firing rate using `meanFiringRate()`.

## Create SpikeTrain objects 

Here is how to create a spike train object. We will use the RecSession object from the previous chapter.

```{r real_spike_trains}
library(relectro)
## assign the name of the session to a variable called session
session="jp19841-10072015-0108"
## assign the session directory to a variable called datadir
datadir="~/Downloads/data_relectro_doc/circular_arena/jp19841/jp19841-10072015-0108"
## create a RecSession object
rs<-new("RecSession",session=session,path=datadir)
rs<-loadRecSession(rs)
# create SpikeTrain object and load data
st<-new("SpikeTrain",session=rs@session,path=rs@path)
st<-loadSpikeTrain(st) # load res clu and sampling rate
print(st)
```

As with other objects, you can get a list of the attributes of your SpikeTrain object with `?SpikeTrain` and you can access them with `@`
```{R SpikeTrain_attributes}
?SpikeTrain
print(paste("Sampling rate of st", st@samplingRate, "Hz"))
print(paste("Number of cells in st:",st@nCells))
```

## SpikeTrain Methods
List the methods of the SpikeTrain class
```{R methods_SpikeTrain}
methods(class=SpikeTrain)
```

## Mean firing rate
Use `meanFiringRate` to calculate the mean firing rate of neurons.
```{R meanFiringRate}
st<-meanFiringRate(st)
```
The method `meanFiringRate` returns a SpikeTrain object. This new SpikeTrain object is assigned to `st`.

You can access the firing rate values using `@`.
```{R print_meanFiringRate}
print(st@meanFiringRate)
```
This is the mean firing rate of all neurons in the SpikeTrain object for the entire recording session.

If you are curious and wants to see the code of the `meanFiringRate` method, use getMethod.
```{R seeCode}
getMethod("meanFiringRate","SpikeTrain")
```
In this method, there is a call to the `.Call()` function. 
This means that the firing rate is calculated using c code instead of within R. 
The first argument of `.Call()` is `meanFiringRate_cwrap`, which is the name of a c function.
If you have the source code of *relectro*, all c functions are defined in the directory `src`.

## Limit analysis to time intervals

It is often useful to limit the analysis to specific parts of the recording session.
Time intervals are used for this purpose.
Time is in sample values and not in seconds.

To limit the analysis to some time intervals, you need to set these intervals in the SpikeTime object.
By default, the intervals in the SpikeTime object are set from the beginning to the end of the recording session.
```{R setIntervals}
print(st)
```
You can see that there is `r length(st@startInterval)` interval set by default.
Now we set the intervals to the second trial of the recording session.
We use the RecSession object to get the start and end time of the second trial.
The method `setIntervals` of the SpikeTime class let you set these intervals in a SpikeTime object.
```{R setIntervals2}
st<-setIntervals(st,rs@trialStartRes[2],rs@trialEndRes[2])
print(st)
```
Now we have one interval of `r sum(st@endInterval-st@startInterval)/st@samplingRate` seconds in the `st` object.
If you now recalculate the mean firing rate of the neurons, the analysis will be limited to the data within this interval.

```{R setIntervals3}
st<-meanFiringRate(st)
print(st@meanFiringRate)
```

You could calculate the difference in firing rate between the second and third trials. 
```{R compareMeanFiringRate}
## get a SpikeTrain object with intervals set at 3rd trial
st3<-setIntervals(st,rs@trialStartRes[3],rs@trialEndRes[3])
## get firing rate with SpikeTrain, limited to 3rd trial
st3<-meanFiringRate(st3)
print(st3@meanFiringRate)
## print the difference in firing rate between 
## trial 2 and 3
st3@meanFiringRate-st@meanFiringRate
```

## Limit analysis to some cells

It is sometimes useful to perform some analysis to a subset of cells. 
For example, you could want to analyze only cells with a firing rate higher than 2 Hz during the second trial.
All you have to do is to set the attribute `cellList` in the SpikeTrain object.
By defaut, the `cellList` attribute of the SpikeTrain object includes all recorded neurons.
```{R setCellList}
## set intervals to 2nd trial (was already set to these intervals)
st<-setIntervals(st,rs@trialStartRes[2],rs@trialEndRes[2])
print(st@cellList)
## which cells have mean friring rate above 2 in 2nd trial
st@meanFiringRate>2
## get the cluster number of these cells
st@cellList[st@meanFiringRate>2]
## set the new cellList in the st object
st<-setCellList(st,st@cellList[st@meanFiringRate>2])
print(st@cellList)
## now analysis will be performed only on these cells
## get the firing rate during the fourth trial
st<-setIntervals(st,rs@trialStartRes[4],rs@trialEndRes[4])
st<-meanFiringRate(st)
print(st@meanFiringRate)
```


## Spike-time autocorrelation

## Spike-time crosscorrelation between cells

## Spike-time crosscorrelation to events

## Instantaneous firing rate

## Simulated spike trains
<!-- st<-spikeTimeCrosscorrelation(st, -->
<!--                               binSizeMs=1, -->
<!--                               windowSizeMs = 200, -->
<!--                               probability = T) -->
<!-- cross<- spikeTimeCrosscorrelationAsDataFrame(st) -->
<!-- plot(cross$time[which(cross$clu1==2&cross$clu2==5)], -->
<!--      cross$prob[which(cross$clu1==2&cross$clu2==5)], -->
<!--      ylim=c(0,max(cross$prob[which(cross$clu1==2&cross$clu2==5)])), -->
<!--      type='l',ylab="Spike probability",xlab="Time (ms)",main="cc cells 2 and 5") -->

<!-- ## set some events, in this case the spikes of clu 2 -->
<!-- st<-setEvents(st,events=st@res[which(st@clu==2)]) -->
<!-- st<-spikeTimeCrosscorrelationEvents(st) -->
<!-- cc<-spikeTimeCrosscorrelationEventsAsDataFrame(st) -->
<!-- plot(cc$time[which(cc$clu==6)], -->
<!--      cc$count[which(cc$clu==6)], -->
<!--      ylim=c(0,max(cc$count[which(cc$clu==6)])), -->
<!--      ylab="Spike count",xlab="Time (ms)",type='l',main="cc spike cells 2 and 6") -->
<!-- rm(cross,cc,clufile) -->
<!-- ``` -->

<!-- ### Working with simulated spike trains -->


<!-- ```{r simulate_spike_train} -->
<!-- ## generate spikes for 3 neurons   -->
<!-- res1<-cumsum(rpois(n=1000,lambda=10)) -->
<!-- res2<-cumsum(rpois(n=1000,lambda=15)) -->
<!-- res3<-cumsum(rpois(n=1000,lambda=20)) -->
<!-- clu<-c(rep(1,1000),rep(2,1000),rep(3,1000)) -->
<!-- df<-data.frame(res=c(res1,res2,res3),clu=clu) -->
<!-- df<-df[order(df$res),] # sort according to res values -->
<!-- ## create a SpikeTrain object from random spikes ### -->
<!-- st<-new("SpikeTrain") -->
<!-- ## set the spike trains in the object -->
<!-- st<-setSpikeTrain(st=st,res=df$res,clu=df$clu,samplingRate=20000) -->
<!-- ## get the spike-time autocorrelation -->
<!-- st<-spikeTimeAutocorrelation(st,binSizeMs=10,windowSizeMs=500,probability = F) -->
<!-- auto<-spikeTimeAutocorrelationAsDataFrame(st) -->
<!-- ## plot the autocorrelation -->
<!-- plot(auto$time[which(auto$clu==1)],auto$count[which(auto$clu==1)], -->
<!--      ylim=c(0,max(auto$count[which(auto$clu==1)])),type='l',ylab="Spike count", xlab="time (ms)") -->
<!-- lines(auto$time[which(auto$clu==2)],auto$count[which(auto$clu==2)],col="red") -->
<!-- lines(auto$time[which(auto$clu==3)],auto$count[which(auto$clu==3)],col="blue") -->
<!-- ## get the mean firing rate -->
<!-- st<-meanFiringRate(st) -->
<!-- st@meanFiringRate -->
<!-- rm(clu,res1,res2,res3,df,auto,st) -->
<!-- ``` -->


<!-- If you want to calculate a spike-time crosscorrelation between the spikes and some events, you need to set some events within you SpikeTrain object with the function `setEvents()` and then call `spikeTimeCrosscorrelationEvents()`. This could be usefull to see if a cell react to some sort of stimulation or some behavioural events. -->

<!-- ### Limiting the analysis to a set of time intervals -->

<!-- Most computations on neuronal activity need to be performed on a limited time period. This is acheived by setting some intervals in the SpikeTime object. You can do this with the function `setIntervals()`. The intervals of the SpikeTrain object are used when analyzing the spatial properties of neurons. -->




<!-- ```{r SpikeTrain_list_methods} -->
<!-- library(relectro) -->
<!-- methods(class="SpikeTrain") -->
<!-- ``` -->



<!-- To calculate instantaneous firing rate from the spike trains -->
<!-- ```{r ifr} -->
<!-- ## calculate instantaneous firing rates -->
<!-- st<-ifr(st) -->
<!-- ## plot ifr and spike of a cell -->
<!-- n=400 -->
<!-- cell=1 -->
<!-- plot(head(st@ifrTime,n),head(st@ifr[cell,],n), -->
<!--      type='l',xlab="Time (sec)",ylab="Rate (Hz)") -->
<!-- points(head(st@res[which(st@clu==st@cellList[cell])]/st@samplingRate,n), -->
<!--        rep(0,n),col='red') -->
<!-- rm(n,cell) -->
<!-- ``` -->
